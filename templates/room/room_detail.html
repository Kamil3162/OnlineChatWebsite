{% extends 'base.html' %}
{% load static %}
{% block content %}
<div>
    <link rel="stylesheet" href="{% static 'global.css' %}">
    <link rel="stylesheet" href="{% static 'right-sidebar.css' %}">
    <div>
        <form method="post">
            {% csrf_token %}
            {{ form.as_p }}
            <button type="submit">Pass</button>
        </form>
    </div>
    <!--- mozna dodac opcje resign i wypisac ze z czatu zwolnic miejsce innym -->
    <div class="chat-window">
        {{ information }}
        {% for message in messages %}
            {% if message.sender_id == request.user.id %}
                <div class="your-messages">
                    <!-- {{ request.user.username}} -->
                    <div class="message-display">
                        {{ message.message_content }}<br/>
                    </div>
                </div>
            {% else %}
                <div class="others-messages">
                    <!-- {{ request.user.username}} -->
                    <div class="message-display">
                        {{ message.message_content }}<br/>
                    </div>
                </div>
            {% endif %}
        {% endfor %}
        <div id="messages-container">
            <!-- Chat messages will be dynamically added here -->
        </div>
    </div>
    <div>
        <form id="message-form">
            <input type="text" id="message-input">
            <button type="submit" onclick="scrollToBottom()">Send</button>
        </form>
    </div>


</div>
<script>
    console.log("esa");

    function scrollToBottom() {
        const chatWindow = document.querySelector('.chat-window');
        chatWindow.scrollTop = chatWindow.scrollHeight;
    }

    const messageContainer = document.getElementById('messages-container');
    var roomDetailJson = JSON.parse('{{ room_detail|escapejs }}');
    console.log(roomDetailJson);
    var url = window.location.href;
    var parts = url.split('/');
    const room_id = parts[parts.length - 2];
    var userId = "{{ request.user.id }}";
    var socket = new WebSocket(`ws://localhost:8000/ws/server-url/${room_id}/`);
    window.addEventListener('load', scrollToBottom);

    socket.onmessage = function (e) {
        let data = JSON.parse(e.data);
        console.log(data);
        if (userId == data.userId) {
            messageContainer.insertAdjacentHTML('beforeend',
                    `<div class="message-container">
                 <div class="your-messages">
                     <div class="message-display">
                         <p>${data.message}</p>
                     </div>
                     <p>${data.sender_data}</p>
                 </div>
             </div>`);
        } else {
            messageContainer.insertAdjacentHTML('beforeend',
                    `<div class="message-container">
                 <div class="others-messages">
                    <div id="user">
                        <p>${data.sender_data}</p>
                    </div>
                     <div class="message-display">
                         <p>${data.message}</p>
                     </div>
                 </div>
             </div>`);

        }
        scrollToBottom();
        console.log(userId);
        console.log(data.userId);
    };

    document.querySelector('#message-form').addEventListener('submit', function (event) {
        event.preventDefault(); // Prevent form submission
        var inputField = document.querySelector("#message-input");
        var message = inputField.value.trim();  // remove all white spaces
        inputField.value = '';
        console.log(message);
        if (message != "") {
            socket.send(
                    JSON.stringify({
                        message: message,
                        room_id: room_id,
                        user_id: userId
                    }));
        } else {
            console.log("nie udalo sie wyslac wiadomosci");
        }
    });

    socket.onerror = function (error) {
        console.log(error);
    };
</script>

{% endblock %}