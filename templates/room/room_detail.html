{% extends 'base.html' %}
{% load static %}
{% block content %}
<div>
    <link rel="stylesheet" href="{% static 'global.css' %}">
    <link rel="stylesheet" href="{% static 'right-sidebar.css' %}">
    <div>
        <form method="post">
            {% csrf_token %}
            {{ form.as_p }}
            <button type="submit">Pass</button>
        </form>
    </div>
    <div class="chat-window">
        {{ information }}
        {% for message in messages %}
            {% if message.sender_id == request.user.id %}
                <div class="your-messages">
                    <!-- {{ request.user.username}} -->
                    <div class="message-display">
                        {{ message.message_content }}<br/>
                    </div>
                </div>
            {% else %}
                <div class="others-messages">
                    <!-- {{ request.user.username}} -->
                    <div class="message-display">
                        {{ message.message_content }}<br/>
                    </div>
                </div>
            {% endif %}
        {% endfor %}
        <div id="messages-container">
            <!-- Chat messages will be dynamically added here -->
        </div>
    </div>
    <div>
        <form id="message-form">
            <input type="text" id="message-input">
            <button type="submit" onclick="buttonClick()">Send</button>
        </form>
    </div>

    <script>


        var url = window.location.href;
        var parts = url.split('/');
        const room_id = parts[parts.length - 2];
        var userId = "{{ request.user.id }}";
        console.log("to jest testowanie chatu python JS");
        console.log(userId);
        var socket = new WebSocket(`ws://localhost:8000/ws/server-url/${room_id}/`);

        socket.onmessage = function (e) {
            let data = JSON.parse(e.data);
            console.log(data);
            const messageContainer = document.getElementById('messages-container');
            if (userId == data.userId){
                messageContainer.insertAdjacentHTML('beforeend',
                    `<div class="message-container">
                        <div class="your-messages">
                            <div class="message-display">
                                <p>${data.message}</p>
                            </div>
                        </div>
                    </div>`);
            }
            else{
                messageContainer.insertAdjacentHTML('beforeend',
                    `<div class="message-container">
                        <div class="others-messages">
                            <div class="message-display">
                                <p>${data.message}</p>
                            </div>
                            <p>${data.sender_data}</p>
                        </div>
                    </div>`);
            }

            console.log(userId);
            console.log(data.userId);
        };

        document.querySelector('#message-form').addEventListener('submit', function (event) {
            event.preventDefault(); // Prevent form submission
            var inputField = document.querySelector("#message-input");
            var message = inputField.value.trim();  // remove all white spaces
            inputField.value = '';
            console.log(message);
            if (message != ""){
                socket.send(
                    JSON.stringify({
                        message: message,
                        room_id: room_id,
                        user_id: userId
                    }));
            }
            else {
                console.log("nie udalo sie wyslac wiadomosci");
            }
        });

        socket.onerror = function (error) {
            console.log(error);
        };
    </script>
</div>

{% endblock %}